<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ZBook</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* {
  box-sizing: border-box;
}

body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  margin: 0; 
  background: linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);
  min-height: 100vh;
  line-height: 1.5;
}

/* Header */
header { 
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(0,0,0,0.1);
  padding: 1rem 2rem;
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

header h1 { 
  margin: 0; 
  font-size: 1.8rem;
  font-weight: 700;
  color: #2c3e50;
  letter-spacing: -0.5px;
}

.menu {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.menu span {
  font-weight: 600;
  color: #2c3e50;
}

.menu button { 
  background: linear-gradient(135deg, #1877f2, #42a5f5);
  color: white;
  border: none; 
  padding: 0.5rem 1rem;
  border-radius: 25px;
  cursor: pointer; 
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.menu button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Container for main content */
.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

/* Cards */
.card { 
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 1.5rem;
  margin-bottom: 2rem;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  border: 1px solid rgba(255,255,255,0.2);
}

.login-box {
  max-width: 400px;
  margin: 4rem auto;
}

.login-box h2 {
  text-align: center;
  color: #2c3e50;
  margin-bottom: 1.5rem;
  font-weight: 600;
}

/* Welcome section */
.welcome {
  text-align: center;
  margin-bottom: 2rem;
}

.welcome h2 {
  color: #2c3e50;
  margin-bottom: 1rem;
  font-weight: 600;
}

.welcome-image {
  margin: 1.5rem 0;
}

.welcome-image img {
  max-width: 300px;
  height: auto;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

/* Users section */
.users-section h3 {
  color: #2c3e50;
  margin-bottom: 1rem;
  font-weight: 600;
  font-size: 1.1rem;
}

.users { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.user-tile { 
  height: 50px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  font-weight: 500;
  color: #495057;
}

.user-tile:hover { 
  background: #e3f2fd;
  border-color: #1877f2;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(24, 119, 242, 0.2);
}

.active-user { 
  background: linear-gradient(135deg, #1877f2, #42a5f5);
  color: white;
  border-color: #166fe5;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(24, 119, 242, 0.3);
}

.active-user::after { 
  content: " (You)"; 
  font-size: 0.75rem;
  opacity: 0.9;
}

/* Post creation */
.post-creation h3 {
  color: #2c3e50;
  margin-bottom: 1rem;
  font-weight: 600;
  font-size: 1.1rem;
}

/* Form elements */
input, textarea, button { 
  width: 100%;
  padding: 0.75rem;
  border-radius: 8px;
  border: 2px solid #e9ecef;
  font-size: 1rem;
  transition: all 0.3s ease;
  font-family: inherit;
}

input:focus, textarea:focus {
  outline: none;
  border-color: #1877f2;
  box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.1);
}

textarea { 
  resize: vertical;
  min-height: 100px;
  margin-bottom: 1rem;
}

button {
  background: linear-gradient(135deg, #1877f2, #42a5f5);
  color: white;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(24, 119, 242, 0.3);
}

button:active {
  transform: translateY(0);
}

/* Feed section */
.feed h3 {
  color: #2c3e50;
  margin-bottom: 1rem;
  font-weight: 600;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.back-btn { 
  background: #6c757d;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.85rem;
  width: auto;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.back-btn:hover {
  background: #5a6268;
}

/* Posts */
.posts-container {
  max-height: 600px;
  overflow-y: auto;
  padding-right: 0.5rem;
}

.posts-container::-webkit-scrollbar {
  width: 6px;
}

.posts-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.posts-container::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.post { 
  background: #f8f9fa;
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 12px;
  border-left: 4px solid #e9ecef;
  transition: all 0.3s ease;
}

.post:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.own { 
  border-left-color: #1877f2;
  background: linear-gradient(135deg, rgba(24, 119, 242, 0.1), rgba(66, 165, 245, 0.1));
}

.post-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.5rem;
}

.post-author {
  font-weight: 600;
  color: #2c3e50;
}

.post-content {
  color: #495057;
  margin-bottom: 0.75rem;
  word-break: break-word;
}

.post-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.timestamp { 
  font-size: 0.8rem;
  color: #6c757d;
}

.actions {
  display: flex;
  gap: 0.5rem;
}

.actions button { 
  width: auto;
  padding: 0.25rem 0.75rem;
  font-size: 0.8rem;
  border-radius: 6px;
}

.actions .edit-btn {
  background: #28a745;
}

.actions .edit-btn:hover {
  background: #218838;
}

.actions .delete-btn {
  background: #dc3545;
}

.actions .delete-btn:hover {
  background: #c82333;
}

.error-message {
  color: #dc3545;
  font-size: 0.9rem;
  margin-top: 0.5rem;
  text-align: center;
}

/* Empty states */
.empty-state {
  text-align: center;
  color: #6c757d;
  padding: 2rem;
  font-style: italic;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .container {
    padding: 1rem 0.5rem;
  }
  
  header {
    padding: 1rem;
    flex-direction: column;
    gap: 0.5rem;
    position: static;
  }
  
  header h1 {
    font-size: 1.5rem;
  }
  
  .menu {
    width: 100%;
    justify-content: center;
  }
  
  .card {
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 12px;
  }
  
  .users {
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 0.5rem;
  }
  
  .user-tile {
    height: 40px;
    font-size: 0.8rem;
  }
  
  .welcome-image img {
    max-width: 250px;
  }
  
  .feed h3 {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .posts-container {
    max-height: 500px;
  }
  
  .post-header {
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .post-footer {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
}

@media (max-width: 480px) {
  .users {
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
  }
  
  .user-tile {
    height: 35px;
    font-size: 0.75rem;
  }
  
  .welcome-image img {
    max-width: 200px;
  }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://acwacaljpzipqgpqkbnk.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjd2FjYWxqcHppcHFncHFrYm5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzkxOTUsImV4cCI6MjA3MTAxNTE5NX0.kvxlmLH9mmN13Z-HZGMJ_chHZXHqlOQajk4qRB1QjWk";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let filterUser = null;

function showLogin() {
  document.getElementById("loginBox").style.display="block";
}

async function login() {
  const u = document.getElementById("userId").value.trim();
  const p = document.getElementById("password").value.trim();

  if (!u || !p) {
    document.getElementById("loginError").innerText = "Please enter both User ID and Password";
    return;
  }

  const { data, error } = await supabase
    .from("users")
    .select("*")
    .eq("id", u)
    .eq("password", p)
    .single();

  if (error) {
    console.error("Login error:", error);
    document.getElementById("loginError").innerText="Invalid login credentials!";
    return;
  }

  if (data) {
    currentUser = data.id;
    document.getElementById("loginBox").style.display="none";
    document.getElementById("app").style.display="block";
    document.getElementById("currentUser").innerText=currentUser;
    document.getElementById("menuBox").innerHTML =
      `<span>Welcome, ${currentUser}</span> <button onclick="logout()">Logout</button>`;
    renderUsers();
    loadPosts();
  } else {
    document.getElementById("loginError").innerText="Invalid login credentials!";
  }
}

function logout() {
  currentUser = null;
  filterUser = null;
  document.getElementById("app").style.display="none";
  document.getElementById("loginBox").style.display="none";
  document.getElementById("menuBox").innerHTML = `<button onclick="showLogin()">Login</button>`;
}

async function renderUsers() {
  const { data: users } = await supabase.from("users").select("*");
  const container = document.getElementById("usersList");
  container.innerHTML="";
  
  if (!users || users.length === 0) {
    container.innerHTML = '<div class="empty-state">No users found</div>';
    return;
  }
  
  users.forEach(u=>{
    const div=document.createElement("div");
    div.className="user-tile";
    if(currentUser === u.id) div.classList.add("active-user");
    div.innerText=u.id;
    div.onclick = ()=>{ filterByUser(u.id); };
    container.appendChild(div);
  });
}

function filterByUser(username) {
  filterUser = username;
  document.getElementById("feedTitle").innerHTML = 
    `${username}'s Posts <button class="back-btn" onclick="backToFeed()">← Back to Feed</button>`;
  loadPosts();
}

function backToFeed() {
  filterUser = null;
  document.getElementById("feedTitle").innerHTML = "Recent Posts";
  loadPosts();
}

async function addPost() {
  const txt=document.getElementById("newPost").value.trim();
  if(txt.length===0) {
    alert("Please write something before posting!");
    return;
  }

  const { error } = await supabase.from("posts").insert([
    { user: currentUser, text: txt, time: new Date().toISOString() }
  ]);

  if (error) {
    console.error("Post insert error:", error);
    alert("Error posting your message. Please try again.");
    return;
  }

  document.getElementById("newPost").value="";
  backToFeed();
}

async function loadPosts() {
  // Try multiple sorting methods to catch all posts
  let query = supabase.from("posts").select("*");
  
  // First try sorting by time, then by id as fallback
  try {
    query = query.order("time", { ascending: false });
  } catch (e) {
    console.log("Time sorting failed, trying id sorting:", e);
    query = query.order("id", { ascending: false });
  }
  
  if(filterUser) query = query.eq("user", filterUser);

  const { data: posts, error } = await query;
  if (error) { 
    console.error("Load posts error:", error);
    // Try a simpler query without ordering as fallback
    const { data: fallbackPosts } = await supabase.from("posts").select("*");
    if (fallbackPosts) {
      renderPosts(fallbackPosts.reverse()); // Show newest first
      return;
    }
    return; 
  }

  console.log("Loaded posts:", posts); // Debug log to see what we got
  renderPosts(posts || []);
}

function renderPosts(posts) {
  const container = document.getElementById("posts");
  container.innerHTML = "";
  
  if (!posts || posts.length === 0) {
    container.innerHTML = '<div class="empty-state">No posts yet. Be the first to share something!</div>';
    return;
  }
  
  console.log(`Rendering ${posts.length} posts`); // Debug log
  
  posts.forEach((post, index) => {
    const div = document.createElement("div");
    div.className = "post" + (post.user === currentUser ? " own" : "");
    
    const postHeader = document.createElement("div");
    postHeader.className = "post-header";
    postHeader.innerHTML = `<span class="post-author">${post.user || 'Unknown User'}</span>`;
    
    const postContent = document.createElement("div");
    postContent.className = "post-content";
    postContent.textContent = post.text || '(No content)';
    
    const postFooter = document.createElement("div");
    postFooter.className = "post-footer";
    
    const timestamp = document.createElement("span");
    timestamp.className = "timestamp";
    
    // Handle different date formats that might exist
    let displayTime = "(no time)";
    if (post.time) {
      try {
        displayTime = new Date(post.time).toLocaleString();
      } catch (e) {
        displayTime = post.time; // Use original if parsing fails
      }
    } else if (post.created_at) {
      try {
        displayTime = new Date(post.created_at).toLocaleString();
      } catch (e) {
        displayTime = post.created_at;
      }
    }
    
    timestamp.textContent = displayTime;
    postFooter.appendChild(timestamp);
    
    if (post.user === currentUser) {
      const actions = document.createElement("div");
      actions.className = "actions";
      actions.innerHTML = `
        <button class="edit-btn" onclick="editPost('${post.id}')">Edit</button>
        <button class="delete-btn" onclick="deletePost('${post.id}')">Delete</button>
      `;
      postFooter.appendChild(actions);
    }
    
    div.appendChild(postHeader);
    div.appendChild(postContent);
    div.appendChild(postFooter);
    container.appendChild(div);
  });
}

async function editPost(id) {
  const { data: post } = await supabase.from("posts").select("*").eq("id", id).single();
  const newText=prompt("Edit your post:",post.text);
  if(newText!==null && newText.trim()!=="") {
    await supabase.from("posts").update({ text: newText.trim() }).eq("id", id);
    loadPosts();
  }
}

async function deletePost(id) {
  if (confirm("Are you sure you want to delete this post?")) {
    await supabase.from("posts").delete().eq("id", id);
    loadPosts();
  }
}

// Allow Enter key to submit forms
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('password').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      login();
    }
  });
  
  document.getElementById('newPost').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
      addPost();
    }
  });
});
</script>
</head>
<body>
<header>
  <h1>ZBook</h1>
  <div class="menu" id="menuBox">
    <button onclick="showLogin()">Login</button>
  </div>
</header>

<div class="login-box card" id="loginBox" style="display:none;">
  <h2>Welcome to ZBook</h2>
  <input type="text" id="userId" placeholder="Enter your User ID">
  <input type="password" id="password" placeholder="Enter your Password">
  <button onclick="login()">Login</button>
  <p class="error-message" id="loginError"></p>
</div>

<div id="app" style="display:none;">
  <div class="container">
    <div class="welcome card">
      <h2>Welcome to ZBook, <span id="currentUser"></span>!</h2>
      <div class="welcome-image">
        <img src="img2.png" alt="ZBook Community">
      </div>
    </div>

    <div class="card users-section">
      <h3>Community Members</h3>
      <div class="users" id="usersList"></div>
    </div>

    <div class="card post-creation">
      <h3>Share Your Thoughts</h3>
      <textarea id="newPost" maxlength="1400" placeholder="What's on your mind? (max 1400 characters)"></textarea>
      <button onclick="addPost()">Share Post</button>
    </div>
    
    <div class="card feed">
      <h3 id="feedTitle">Recent Posts</h3>
      <div class="posts-container">
        <div id="posts"></div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
